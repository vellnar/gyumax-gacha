<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ガチャ抽選</title>
<style>
body {
  margin: 0;
  padding: 0;
  text-align: center;
  font-family: 'Yu Gothic', sans-serif;
  background: #f0f0f0;
  overflow: hidden;
}

/* ガチャマシン */
.machine-container {
  position: relative;
  width: 100%;
  max-width: 320px;
  height: 250px;
  background: #ccc;
  margin: 50px auto 0;
  border-radius: 10px;
}
#handle {
  width: 80px;
  height: 80px;
  background: #888;
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  cursor: pointer;
  border-radius: 50%;
}

/* カプセル */
#capsule-container {
  position: relative;
  width: 80px;
  height: 80px;
  margin: 30px auto;
  display: none;
}
#capsule {
  width: 100%;
  height: 100%;
  background: red;
  border-radius: 50%;
  position: absolute;
  top: -100vh; /* 初期は画面外上部 */
}
#tapOverlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  font-size: 18px;
  color: #fff;
  text-align: center;
  line-height: 80px;
  background: rgba(0,0,0,0.5);
  cursor: pointer;
  display: none;
  border-radius: 10px;
}

/* タイプライター表示 */
#message {
  font-size: 20px;
  background: rgba(255,255,255,0.8);
  border-radius: 10px;
  padding: 10px 15px;
  max-width: 80%;
  margin: 20px auto;
  text-align: center;
  box-shadow: 0 0 8px rgba(0,0,0,0.2);
  position: relative;
  color: #fff; /* 白文字に設定 */
}

/* アニメーション */
@keyframes spin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
@keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-10px);} 75%{transform:translateX(10px);} }
@keyframes dropBounce {0%{top:-100vh;} 70%{top:50%;} 85%{top:40%;} 100%{top:45%;}}
.spin { animation: spin 1s linear; }
.shake { animation: shake 1s; }
.drop { animation: dropBounce 1.5s ease-out forwards; }

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  z-index: 10;
}
</style>
</head>
<body>

<div class="overlay" id="overlay"></div>

<div class="machine-container">
  <div id="handle"></div>
</div>

<div id="capsule-container">
  <div id="capsule"></div>
  <div id="tapOverlay">タップ！</div>
</div>

<div id="message"></div>

<script>
// --- 仮セリフ ---
const loadingTextMap = {
  A: [{key:"A1",text:"セリフ1"},{key:"A2",text:"セリフ2"},{key:"A3",text:"セリフ3"},{key:"A4",text:"セリフ4"}],
  B: [{key:"B1",text:"セリフ5"},{key:"B2",text:"セリフ6"},{key:"B3",text:"セリフ7"},{key:"B4",text:"セリフ8"}],
  C: [{key:"C1",text:"セリフ9"},{key:"C2",text:"セリフ10"},{key:"C3",text:"セリフ11"},{key:"C4",text:"セリフ12"}],
  D: [{key:"D1",text:"セリフ13"},{key:"D2",text:"セリフ14"},{key:"D3",text:"セリフ15"},{key:"D4",text:"セリフ16"}],
  E: [{key:"E1",text:"セリフ17"},{key:"E2",text:"セリフ18"},{key:"E3",text:"セリフ19"},{key:"E4",text:"セリフ20"}],
  F: [{key:"F1",text:"セリフ21"},{key:"F2",text:"セリフ22"},{key:"F3",text:"セリフ23"},{key:"F4",text:"セリフ24"}],
  G: [{key:"G1",text:"セリフ25"},{key:"G2",text:"セリフ26"},{key:"G3",text:"セリフ27"},{key:"G4",text:"セリフ28"}],
  H: [{key:"H1",text:"セリフ29"},{key:"H2",text:"セリフ30"},{key:"H3",text:"セリフ31"},{key:"H4",text:"セリフ32"}],
  I: [{key:"I1",text:"セリフ33"},{key:"I2",text:"セリフ34"},{key:"I3",text:"セリフ35"},{key:"I4",text:"セリフ36"}]
};

// --- タイプライター ---
function typeWriterEffect(element, text, speed = 60){
  element.textContent = "";
  let i = 0;
  function typing(){
    if(i < text.length){
      element.textContent += text.charAt(i);
      i++;
      setTimeout(typing,speed);
    }
  }
  typing();
}

// --- URLからID取得 ---
const urlParams = new URLSearchParams(window.location.search);
let id = urlParams.get("id")?.toUpperCase();
if(!id || !loadingTextMap[id]){
  window.location.href = "error.html";
}

// --- セリフ抽選 ---
const storageKey = `gyumax_msg_${id}`;
let shownKeys = [];
try{shownKeys = JSON.parse(localStorage.getItem(storageKey))||[];}catch{shownKeys=[];}
const messages = loadingTextMap[id];
const notShown = messages.filter(m => !shownKeys.includes(m.key));
let selectedMsg;
if(notShown.length === 0){
  shownKeys = [];
  selectedMsg = messages[Math.floor(Math.random() * messages.length)];
}else{
  selectedMsg = notShown[Math.floor(Math.random() * notShown.length)];
  shownKeys.push(selectedMsg.key);
  localStorage.setItem(storageKey,JSON.stringify(shownKeys));
}

// --- 要素取得 ---
const messageBox = document.getElementById("message");
const handle = document.getElementById("handle");
const capsuleContainer = document.getElementById("capsule-container");
const capsule = document.getElementById("capsule");
const tapOverlay = document.getElementById("tapOverlay");
const overlay = document.getElementById("overlay");

// --- 抽選結果 ---
const isAtari = Math.random() < 0.3;
const token = [...crypto.getRandomValues(new Uint8Array(16))]
  .map(v=>"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"[v%62]).join("");
sessionStorage.setItem("gyumax_token",token);

// --- ハンドルクリック ---
handle.addEventListener("click",()=>{
  handle.classList.add("spin");

  // セリフ表示前に画面を暗くする
  overlay.style.display = "block";
  
  capsuleContainer.style.display = "block";
  capsule.classList.add("shake");

  // 震える1秒後にセリフ表示
  setTimeout(()=>{
    // セリフをタイプライター表示
    typeWriterEffect(messageBox, selectedMsg.text, 60);

    // セリフが終わるのを目安にカプセル落下
    setTimeout(()=>{
      overlay.style.display = "none"; // セリフ表示後に明るさを戻す
      capsule.classList.add("drop");

      // カプセル落下後にタップ表示
      setTimeout(()=>{
        tapOverlay.style.display = "block";
        tapOverlay.addEventListener("click",()=>{
          // リザルト画面に遷移
          const nextUrl = `result.html?id=${id}&result=${isAtari ? "win" : "lose"}&token=${encodeURIComponent(token)}`;
          window.location.href = nextUrl;
        });
      },1500); // カプセル落下時間
    }, selectedMsg.text.length * 60 + 200); // タイプライター速度に合わせて遅延

  },1000); // ハンドル・マシン演出時間
});
</script>
</body>
</html>
